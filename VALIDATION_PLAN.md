# Test PR Validation Plan

## Overview

This document provides a systematic approach to validating auto-sync translation commits generated by the Dify documentation translation workflow. Use this plan to verify that each change commit in a test PR correctly triggers corresponding auto-sync commits with proper translations.

## Purpose

- Ensure translation workflow operates correctly for all operation types
- Validate incremental translation behavior
- Catch regressions or edge cases early
- Document expected behavior for each operation type

## When to Use This Plan

- After creating new test PRs with various operations (add/edit/delete/rename/move)
- When validating incremental commits in existing test PRs
- Before merging changes to translation workflow logic
- When investigating translation workflow issues

---

## Validation Framework

### Phase 1: Pre-Validation Setup

#### 1.1 Identify Test PR Information

```bash
# Get PR number and branch
PR_NUM=207
BRANCH="test/multiple-adds"

# List all commits in the PR
gh pr view $PR_NUM --json commits --jq '.commits[] | "\(.oid[0:8]) \(.messageHeadline)"'

# Or using git
git log origin/main..origin/$BRANCH --oneline
```

#### 1.2 Map Auto-Sync Commits

```bash
# Find auto-sync commits related to this PR
git log --all --grep="PR #$PR_NUM" --oneline

# Find all translation update commits
git log --all --grep="Update translations for commit" --author="github-actions" --oneline
```

#### 1.3 Baseline Information

For each change commit, record:
- Commit SHA (short)
- Operation type(s): ADD, EDIT, DELETE, RENAME, MOVE
- Files affected
- Expected translations (cn, jp)
- Expected docs.json changes

---

### Phase 2: Per-Commit Validation

For **each change commit** in the test PR, validate the corresponding auto-sync commit.

#### 2.1 Commit Mapping Validation

```bash
CHANGE_COMMIT="fa78b7f9"
AUTOSYNC_COMMIT="aac2948a"

# Verify auto-sync commit references the change commit
git show $AUTOSYNC_COMMIT | grep "Last-Processed-Commit: $CHANGE_COMMIT"
```

**Expected:**
- ‚úÖ Auto-sync commit exists
- ‚úÖ `Last-Processed-Commit` metadata matches change commit SHA
- ‚úÖ `Original-PR` metadata matches PR number
- ‚úÖ Author is `github-actions[bot]`

#### 2.2 File Operations Validation

##### ADD Operations

```bash
# Check files added in change commit
git show --name-status $CHANGE_COMMIT | grep "^A"

# Verify translations were created
git show --name-status $AUTOSYNC_COMMIT | grep "^A.*cn/"
git show --name-status $AUTOSYNC_COMMIT | grep "^A.*jp/"
```

**Expected:**
- ‚úÖ For each `en/path/file.mdx` added ‚Üí `cn/path/file.mdx` created
- ‚úÖ For each `en/path/file.mdx` added ‚Üí `jp/path/file.mdx` created
- ‚úÖ Translation notices present in cn/jp files
- ‚úÖ Content translated (not just copied)

##### EDIT Operations

```bash
# Check files modified in change commit
git show --name-status $CHANGE_COMMIT | grep "^M.*en/"

# Verify translations were updated
git show --name-status $AUTOSYNC_COMMIT | grep "^M.*cn/"
git show --name-status $AUTOSYNC_COMMIT | grep "^M.*jp/"
```

**Expected:**
- ‚úÖ Corresponding cn/jp files modified
- ‚úÖ New content translated
- ‚úÖ Existing content preserved (context-aware translation)
- ‚ùå No duplicate translation notices added

##### DELETE Operations

```bash
# Check files deleted in change commit
git show --name-status $CHANGE_COMMIT | grep "^D.*en/"

# Verify translations were deleted
git show --name-status $AUTOSYNC_COMMIT | grep "^D.*cn/"
git show --name-status $AUTOSYNC_COMMIT | grep "^D.*jp/"
```

**Expected:**
- ‚úÖ Corresponding cn/jp files deleted
- ‚úÖ No orphaned translation files remain

##### RENAME Operations

```bash
# Check renames in change commit (git detects as D + A)
git show --name-status $CHANGE_COMMIT | grep "^D.*en/"
git show --name-status $CHANGE_COMMIT | grep "^A.*en/"

# Verify translations were renamed
git show --name-status $AUTOSYNC_COMMIT
```

**Expected:**
- ‚úÖ Old cn/jp files deleted
- ‚úÖ New cn/jp files created at new location
- ‚úÖ File extensions preserved (.md or .mdx)
- ‚úÖ Content migrated correctly

##### MOVE Operations (docs.json location change)

```bash
# Check docs.json changes
git diff $CHANGE_COMMIT^..$CHANGE_COMMIT -- docs.json
```

**Expected:**
- ‚úÖ File moved in cn/jp sections of docs.json
- ‚úÖ Same group structure maintained (index-based navigation)
- ‚úÖ Physical files unchanged (only docs.json modified)

#### 2.3 docs.json Synchronization

```bash
# Extract and compare docs.json sections
git show $AUTOSYNC_COMMIT:docs.json | jq '.navigation.versions[0].languages[] | select(.language=="en") | .dropdowns[0].pages[0].pages[0].pages' > en_section.json

git show $AUTOSYNC_COMMIT:docs.json | jq '.navigation.versions[0].languages[] | select(.language=="cn") | .dropdowns[0].pages[0].pages[0].pages' > cn_section.json

git show $AUTOSYNC_COMMIT:docs.json | jq '.navigation.versions[0].languages[] | select(.language=="jp") | .dropdowns[0].pages[0].pages[0].pages' > jp_section.json
```

**Validation Checklist:**
- ‚úÖ All en/ paths have corresponding cn/ paths
- ‚úÖ All en/ paths have corresponding jp/ paths
- ‚úÖ Group structure matches across languages
- ‚úÖ File ordering matches (same index positions)
- ‚úÖ Valid JSON (no syntax errors)

#### 2.4 Translation Quality Checks

```bash
# Check for translation notices
git show $AUTOSYNC_COMMIT:cn/path/file.mdx | grep -c "‚ö†Ô∏è Êú¨ÊñáÊ°£Áî± AI Ëá™Âä®ÁøªËØë"
git show $AUTOSYNC_COMMIT:jp/path/file.mdx | grep -c "‚ö†Ô∏è „Åì„ÅÆÊñáÊõ∏„ÅØ AI „Å´„Çà„Å£„Å¶Ëá™ÂãïÁøªË®≥"

# Check frontmatter translated
git show $AUTOSYNC_COMMIT:cn/path/file.mdx | head -5
```

**Expected:**
- ‚úÖ Translation notice present (exactly 1 per file)
- ‚úÖ Frontmatter `title` and `description` translated
- ‚úÖ Code blocks unchanged
- ‚úÖ Links preserved
- ‚úÖ Markdown formatting intact

---

### Phase 3: Common Issues to Check

#### Issue 1: Duplicate Translation Notices

**Symptom:** Multiple `<Note>` blocks with translation warnings

```bash
# Check for duplicates
git show $AUTOSYNC_COMMIT:cn/path/file.mdx | grep -c "<Note> ‚ö†Ô∏è"
```

**Expected:** Count should be 1
**Action if >1:** Flag as issue - incremental updates should not add duplicate notices

#### Issue 2: Missing docs.json Entries

**Symptom:** Files translated but not added to docs.json

```bash
# Check file exists in translation
ls cn/path/file.mdx

# Check entry in docs.json
grep "cn/path/file" docs.json
```

**Expected:** Both should exist
**Action if missing:** Flag as critical issue - navigation will be broken

#### Issue 3: Extension Mismatch in Renames

**Symptom:** File renamed with wrong extension (.md ‚Üî .mdx)

```bash
# Check original extension
git show $CHANGE_COMMIT^:en/path/old-file.mdx

# Check new file has same extension
git show $CHANGE_COMMIT:en/path/new-file.mdx
```

**Expected:** Extensions match
**Action if mismatch:** Flag as bug - extension detection failed

#### Issue 4: Incorrect Index-Based Navigation (Moves)

**Symptom:** File moved to wrong group in cn/jp docs.json

```bash
# Compare group indices
# English: files[0].pages[1].pages ‚Üí "Nodes" group
# Chinese: files[0].pages[1].pages ‚Üí should also be index 1
```

**Expected:** Same nested index across all languages
**Action if mismatch:** Flag as bug - index-based navigation failed

#### Issue 5: Orphaned Translation Files

**Symptom:** cn/jp files exist but corresponding en/ file was deleted

```bash
# List all cn files
find cn/documentation/pages -name "*.mdx" | sed 's|cn/|en/|' | while read enfile; do
  [ ! -f "$enfile" ] && echo "Orphaned: $(echo $enfile | sed 's|en/|cn/|')"
done
```

**Expected:** No orphaned files
**Action if found:** Flag as bug - deletion didn't cascade

---

## Validation Report Template

### PR #[NUM]: [TITLE]

**Branch:** `[branch-name]`
**Total Commits:** [N]
**Languages:** Chinese (cn), Japanese (jp)

---

### Commit Mapping Summary

| # | Change Commit | Auto-Sync Commit | Operations | Status |
|---|---------------|------------------|------------|--------|
| 1 | `abc123` Title | `def456` üåê Initial | 3 ADD | ‚úÖ |
| 2 | `ghi789` Title | `jkl012` üîÑ Update | 1 EDIT, 1 ADD | ‚ö†Ô∏è |
| 3 | `mno345` Title | `pqr678` üîÑ Update | 1 DELETE | ‚úÖ |

---

### Detailed Validation Results

#### Commit 1: `abc123` - [Title]

**Operation:** ADD (3 files)

**Files Changed:**
- ‚úÖ `en/documentation/pages/getting-started/test-file-1.mdx`
- ‚úÖ `en/documentation/pages/getting-started/test-file-2.mdx`
- ‚úÖ `en/documentation/pages/getting-started/test-file-3.mdx`

**Auto-Sync Commit:** `def456` - üåê Initial translations for PR #[NUM]

**Validation:**
- ‚úÖ Translations created: 6 files (3 cn + 3 jp)
- ‚úÖ docs.json synced: entries added to cn and jp sections
- ‚úÖ Translation notices: 1 per file
- ‚úÖ Content translated: verified
- ‚úÖ Metadata correct: Last-Processed-Commit, Original-PR

**Issues:** None

---

#### Commit 2: `ghi789` - [Title]

**Operation:** EDIT (1 file), ADD (1 file)

**Files Changed:**
- ‚úÖ Modified: `en/documentation/pages/getting-started/test-file-1.mdx`
- ‚úÖ Added: `en/documentation/pages/getting-started/test-file-4.mdx`

**Auto-Sync Commit:** `jkl012` - üîÑ Update translations for commit ghi789

**Validation:**
- ‚úÖ Translations updated: cn/jp test-file-1.mdx
- ‚úÖ Translations created: cn/jp test-file-4.mdx
- ‚úÖ docs.json synced: test-file-4 added
- ‚ö†Ô∏è **ISSUE:** Duplicate translation notice in cn/test-file-1.mdx
- ‚úÖ Content translated: verified

**Issues:**
- ‚ö†Ô∏è **Duplicate Translation Notice:** `cn/test-file-1.mdx` has 2 `<Note>` blocks

**Recommendation:** Fix incremental translation logic to avoid re-adding notice

---

### Overall Assessment

**Total Commits Validated:** [N]
**Passed:** [X]
**Issues Found:** [Y]

**Critical Issues:** [count]
**Warnings:** [count]

**Conclusion:** [PASS / FAIL / PASS WITH WARNINGS]

---

### Issues Summary

| Severity | Issue | Affected Files | Recommendation |
|----------|-------|----------------|----------------|
| ‚ö†Ô∏è Warning | Duplicate translation notice | cn/test-file-1.mdx | Fix incremental logic |
| ‚ùå Critical | Missing docs.json entry | cn/test-file-5.mdx | Investigate sync failure |

---

## Automation Scripts

### Script 1: Commit Mapping

```bash
#!/bin/bash
# validate-pr.sh <PR_NUMBER>

PR_NUM=$1
BRANCH=$(gh pr view $PR_NUM --json headRefName -q .headRefName)

echo "=== PR #$PR_NUM: $BRANCH ==="
echo ""

# Get all change commits
echo "Change Commits:"
git log origin/main..origin/$BRANCH --oneline --reverse

echo ""
echo "Auto-Sync Commits:"
git log --all --grep="PR #$PR_NUM" --grep="Update translations" --author="github-actions" --oneline
```

### Script 2: File Count Validation

```bash
#!/bin/bash
# validate-file-counts.sh <AUTOSYNC_COMMIT>

COMMIT=$1

echo "=== File Counts in $COMMIT ==="

# Count files by language
EN_COUNT=$(git show --name-status $COMMIT | grep "^A.*en/.*\.mdx" | wc -l)
CN_COUNT=$(git show --name-status $COMMIT | grep "^A.*cn/.*\.mdx" | wc -l)
JP_COUNT=$(git show --name-status $COMMIT | grep "^A.*jp/.*\.mdx" | wc -l)

echo "English files added: $EN_COUNT"
echo "Chinese files added: $CN_COUNT"
echo "Japanese files added: $JP_COUNT"

if [ $CN_COUNT -eq $EN_COUNT ] && [ $JP_COUNT -eq $EN_COUNT ]; then
  echo "‚úÖ File counts match"
else
  echo "‚ùå File count mismatch!"
fi
```

### Script 3: Translation Notice Check

```bash
#!/bin/bash
# check-translation-notices.sh <AUTOSYNC_COMMIT>

COMMIT=$1

echo "=== Translation Notice Validation ==="

# Get all cn files in commit
git show --name-only $COMMIT | grep "^cn/.*\.mdx$" | while read file; do
  COUNT=$(git show $COMMIT:$file | grep -c "‚ö†Ô∏è Êú¨ÊñáÊ°£Áî± AI Ëá™Âä®ÁøªËØë")

  if [ $COUNT -eq 1 ]; then
    echo "‚úÖ $file"
  elif [ $COUNT -gt 1 ]; then
    echo "‚ö†Ô∏è DUPLICATE in $file (count: $COUNT)"
  else
    echo "‚ùå MISSING in $file"
  fi
done
```

### Script 4: docs.json Validation

```bash
#!/bin/bash
# validate-docs-json.sh <AUTOSYNC_COMMIT>

COMMIT=$1

echo "=== docs.json Validation ==="

# Validate JSON syntax
if git show $COMMIT:docs.json | python3 -m json.tool > /dev/null 2>&1; then
  echo "‚úÖ Valid JSON syntax"
else
  echo "‚ùå Invalid JSON syntax!"
  exit 1
fi

# Extract file lists
EN_FILES=$(git show $COMMIT:docs.json | jq -r '.. | select(.pages? and type == "object") | .pages[]? | select(type == "string" and startswith("en/"))' | sort)
CN_FILES=$(git show $COMMIT:docs.json | jq -r '.. | select(.pages? and type == "object") | .pages[]? | select(type == "string" and startswith("cn/"))' | sed 's|^cn/|en/|' | sort)
JP_FILES=$(git show $COMMIT:docs.json | jq -r '.. | select(.pages? and type == "object") | .pages[]? | select(type == "string" and startswith("jp/"))' | sed 's|^jp/|en/|' | sort)

# Compare
if diff <(echo "$EN_FILES") <(echo "$CN_FILES") > /dev/null; then
  echo "‚úÖ CN structure matches EN"
else
  echo "‚ùå CN structure mismatch!"
fi

if diff <(echo "$EN_FILES") <(echo "$JP_FILES") > /dev/null; then
  echo "‚úÖ JP structure matches EN"
else
  echo "‚ùå JP structure mismatch!"
fi
```

---

## Quick Reference

### Essential Commands

```bash
# View PR commits
gh pr view <PR_NUM> --json commits --jq '.commits[] | "\(.oid[0:8]) \(.messageHeadline)"'

# Find auto-sync for specific commit
git log --all --grep="<COMMIT_SHA>" --author="github-actions"

# Compare file changes
git show --stat <COMMIT>

# Check file content at specific commit
git show <COMMIT>:<FILE_PATH>

# Validate JSON
python3 -m json.tool < docs.json

# Count translation notices
git show <COMMIT>:<FILE> | grep -c "‚ö†Ô∏è"
```

### Expected Auto-Sync Commit Format

```
üåê Initial translations for PR #123
üîÑ Update translations for commit abc123de

Last-Processed-Commit: abc123de...
Original-PR: #123
Languages: Chinese (cn), Japanese (jp)

ü§ñ Generated with GitHub Actions
```

---

## Version History

- **v1.0** (2025-11-15): Initial validation plan created
- **[Future]**: Add validation for edge cases, batch operations, etc.

---

## Notes

- This plan is a living document - update as new edge cases are discovered
- Save validation reports in `docs/validation-reports/` directory
- Use consistent naming: `PR-{NUM}-validation-{DATE}.md`
- Flag all issues in GitHub PR comments for visibility
