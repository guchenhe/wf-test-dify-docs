---
title: 工作流链接测试
description: 测试分析工作流和更新工作流之间的安全工作流链接
---

<Note> ⚠️ 本文档由 AI 自动翻译。如有任何不准确之处，请参考[英文原版](../en/test-workflow-chaining.md)。</Note>

<Note> ⚠️ 本文档由 AI 自动翻译。如有任何不准确之处，请参考[英文原版](../en/test-workflow-chaining.md)。</Note>

# 工作流链接测试

本文件测试新的安全工作流链接实现。

## 测试场景

测试更新工作流：
1. 等待分析工作流完成
2. 从分析工作流下载已验证的构件
3. 使用预验证的 sync_plan.json
4. 执行来自分析工作流的所有安全检查

## 预期行为

- 分析工作流通过安全检查验证输入
- 更新工作流仅在分析成功后运行
- 安全验证无法被绕过
- 增量更新在链接工作流中正常工作

## 增量更新测试

本节用于测试增量更新时的工作流链接。

### 安全验证链

当此更改被推送时：
1. **分析工作流**首先运行（只读权限）
   - 验证文件路径（禁止 `../` 遍历）
   - 检查文件数量限制（最多 50 个文件）
   - 检查文件大小限制（每个文件 10MB）
   - 创建已验证的 `sync_plan.json` 构件
   - 上传构件供更新工作流使用

2. **更新工作流**等待分析完成
   - 由 `workflow_run` 事件触发
   - 从分析工作流下载已验证的构件
   - 加载预验证的 `sync_plan.json`
   - 仅在分析成功后继续
   - 使用已验证的输入（不重新分析）

### 安全保障

✅ 所有安全检查均被强制执行（无法绕过）
✅ 适当的分离：验证（只读）→ 执行（写入）
✅ 构件确保使用已验证的输入
✅ 通过顺序工作流执行实现纵深防御

## 构件命名修复

测试后，我们发现 `workflow_run` 事件的 `pull_requests` 数组中不包含 PR 信息。解决方案是改用工作流运行 ID：

- **分析工作流**：创建名为 `docs-sync-analysis-${{ github.run_id }}` 的构件
- **更新工作流**：使用 `docs-sync-analysis-${{ github.event.workflow_run.id }}` 下载构件

这确保无论 PR 上下文是否可用，都能可靠地定位构件。

### 工作原理

workflow_run 触发器使用**目标分支**（main）的工作流定义，而不是源分支的定义。这意味着：
1. 工作流修复必须先合并到 main 分支才能生效
2. `github.event.workflow_run.id` 在 workflow_run 上下文中始终可用
3. 构件命名在工作流边界之间变得确定且可靠