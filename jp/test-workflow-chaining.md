---
title: ワークフローチェーンテスト
description: 分析ワークフローと更新ワークフロー間の安全なワークフローチェーンのテスト
---

<Note> ⚠️ このドキュメントはAIによって自動翻訳されています。不正確な部分がある場合は、[英語版](../en/test-workflow-chaining.md)を参照してください。</Note>

<Note> ⚠️ このドキュメントはAIによって自動翻訳されています。不正確な部分がある場合は、[英語版](../en/test-workflow-chaining.md)を参照してください。</Note>

# ワークフローチェーンテスト

このファイルは、新しい安全なワークフローチェーン実装をテストします。

## テストシナリオ

更新ワークフローのテスト内容：
1. 分析ワークフローの完了を待機する
2. 分析ワークフローから検証済みのアーティファクトをダウンロードする
3. 事前検証済みのsync_plan.jsonを使用する
4. 分析ワークフローからのすべてのセキュリティチェックを適用する

## 期待される動作

- 分析ワークフローがセキュリティチェックで入力を検証する
- 更新ワークフローは分析が成功した後にのみ実行される
- セキュリティ検証をバイパスできない
- インクリメンタル更新がチェーンされたワークフローで正しく動作する

## インクリメンタル更新テスト

このセクションは、インクリメンタル更新時のワークフローチェーンをテストするために追加されました。

### セキュリティ検証チェーン

この変更がプッシュされると：
1. **分析ワークフロー**が最初に実行される（読み取り専用権限）
   - ファイルパスを検証（`../` トラバーサルなし）
   - ファイル数制限をチェック（最大50ファイル）
   - ファイルサイズ制限をチェック（ファイルあたり10MB）
   - 検証済みの`sync_plan.json`アーティファクトを作成
   - 更新ワークフロー用にアーティファクトをアップロード

2. **更新ワークフロー**は分析完了を待機
   - `workflow_run`イベントによってトリガー
   - 分析ワークフローから検証済みアーティファクトをダウンロード
   - 事前検証済みの`sync_plan.json`を読み込み
   - 分析が成功した場合のみ続行
   - 検証済み入力を使用（再分析なし）

### セキュリティ保証

✅ すべてのセキュリティチェックが適用される（バイパス不可）
✅ 適切な分離：検証（読み取り専用）→ 実行（書き込み）
✅ アーティファクトが検証済み入力の使用を保証
✅ シーケンシャルワークフロー実行による多層防御

## アーティファクト命名の修正

テスト後、`workflow_run`イベントが`pull_requests`配列にPR情報を含まないことが判明しました。解決策として、ワークフロー実行IDを使用することにしました：

- **分析ワークフロー**：`docs-sync-analysis-${{ github.run_id }}`という名前のアーティファクトを作成
- **更新ワークフロー**：`docs-sync-analysis-${{ github.event.workflow_run.id }}`を使用してアーティファクトをダウンロード

これにより、PRコンテキストの可用性に関係なく、アーティファクトを確実に特定できます。

### これが機能する理由

workflow_runトリガーは、ソースブランチではなく**ターゲットブランチ**（main）からのワークフロー定義を使用します。これは次のことを意味します：
1. ワークフローの修正は、効果を発揮する前にmainにマージする必要がある
2. `github.event.workflow_run.id`はworkflow_runコンテキストで常に利用可能
3. アーティファクト命名がワークフロー境界を越えて決定論的で信頼性の高いものになる